<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertesia Document Upload</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 60px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 20px;
            font-size: 1.5rem;
            color: #333;
        }
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            margin-bottom: 16px;
            cursor: pointer;
        }
        .file-input:hover { border-color: #007bff; }
        button {
            width: 100%;
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }
        .status.info { background: #e7f3ff; color: #0056b3; display: block; }
        .status.success { background: #d4edda; color: #155724; display: block; }
        .status.error { background: #f8d7da; color: #721c24; display: block; }
        .log {
            margin-top: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .log.show { display: block; }
        .log div { margin-bottom: 4px; }
        .log .step { color: #666; }
        .log .ok { color: #28a745; }
        .log .err { color: #dc3545; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ðŸ“„ Vertesia Upload</h1>
        
        <input type="file" id="fileInput" class="file-input">
        
        <button id="uploadBtn" onclick="uploadDocument()">Upload Document</button>
        
        <div id="status" class="status"></div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        const API_KEY = 'sk-cf3c2d29bc38bfee2ae95bf107cb9046';
        const API_BASE = 'https://api.vertesia.io/api/v1';
        const AUTH_BASE = 'https://api.vertesia.io';

        function log(msg, type = 'step') {
            const logEl = document.getElementById('log');
            logEl.classList.add('show');
            logEl.innerHTML += `<div class="${type}">${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setStatus(msg, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = msg;
        }

        async function getJWT() {
            log('â†’ Getting JWT token...');
            
            // Match the working code: use api.vertesia.io and pass token as query param
            const response = await fetch(`${AUTH_BASE}/auth/token?token=${API_KEY}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`
                }
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`JWT request failed: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            log('âœ“ JWT obtained', 'ok');
            return data.token;
        }

        async function getUploadURL(fileName, mimeType) {
            log(`â†’ Getting upload URL for "${fileName}"...`);
            
            // Can use API key directly for this endpoint
            const response = await fetch(`${API_BASE}/objects/upload-url`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: fileName,
                    mime_type: mimeType
                })
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`Upload URL request failed: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            log(`âœ“ Upload URL received (ID: ${data.id})`, 'ok');
            return data;
        }

        async function uploadToGCS(url, file, mimeType) {
            log('â†’ Uploading file to storage...');
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': mimeType
                },
                body: file
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`GCS upload failed: ${response.status} - ${errText}`);
            }

            log('âœ“ File uploaded successfully!', 'ok');
        }

        async function verifyObject(objectId) {
            log('â†’ Verifying object exists...');
            
            const response = await fetch(`${API_BASE}/objects/${objectId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`
                }
            });

            if (response.ok) {
                const obj = await response.json();
                log(`âœ“ Object verified: ${obj.name}`, 'ok');
                if (obj.content?.source) {
                    log(`  Source: ${obj.content.source}`, 'ok');
                }
                return obj;
            } else {
                log('âš  Object not immediately visible (may need processing time)', 'step');
                return null;
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('uploadBtn');
            const logEl = document.getElementById('log');
            
            // Reset
            logEl.innerHTML = '';
            logEl.classList.remove('show');
            
            // Validate
            if (!fileInput.files.length) {
                setStatus('Please select a file first.', 'error');
                return;
            }

            const file = fileInput.files[0];
            const mimeType = file.type || getMimeType(file.name);
            
            log(`File: ${file.name} (${(file.size/1024).toFixed(1)} KB)`, 'step');
            log(`Type: ${mimeType}`, 'step');
            
            btn.disabled = true;
            setStatus('Uploading...', 'info');

            try {
                // Step 1: Get upload URL (creates object in Vertesia)
                const uploadData = await getUploadURL(file.name, mimeType);

                // Step 2: Upload to GCS
                await uploadToGCS(uploadData.url, file, mimeType);

                // Step 3: Verify object exists
                await verifyObject(uploadData.id);

                setStatus(`Success! Object ID: ${uploadData.id}`, 'success');
                
            } catch (err) {
                log(`âœ— ${err.message}`, 'err');
                setStatus(`Error: ${err.message}`, 'error');
                console.error('Upload error:', err);
            } finally {
                btn.disabled = false;
            }
        }

        function getMimeType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                pdf: 'application/pdf',
                docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                doc: 'application/msword',
                txt: 'text/plain',
                md: 'text/markdown',
                png: 'image/png',
                jpg: 'image/jpeg',
                jpeg: 'image/jpeg',
                xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                xls: 'application/vnd.ms-excel',
                csv: 'text/csv'
            };
            return types[ext] || 'application/octet-stream';
        }
    </script>
</body>
</html>
